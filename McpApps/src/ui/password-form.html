<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pony Password Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 0;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 20px;
            margin-bottom: 20px;
        }
        h1 {
            margin-bottom: 28px;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        input[type="number"],
        input[type="checkbox"] {
            margin-right: 8px;
        }
        input[type="number"] {
            width: 120px;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .ponies-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            max-height: 320px;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .pony-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .pony-checkbox:hover {
            background: #f0f4ff;
            border-color: #667eea;
            transform: translateY(-1px);
        }
        .pony-checkbox input[type="checkbox"]:checked + label {
            font-weight: 600;
            color: #667eea;
        }
        .pony-checkbox input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 24px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            border-left: 5px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result h3 {
            margin-bottom: 16px;
            color: #2e7d32;
            font-size: 18px;
        }
        .password {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin: 8px 0;
            word-break: break-all;
            border: 1px solid #c8e6c9;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .error {
            margin-top: 20px;
            padding: 16px;
            background: #ffebee;
            border-radius: 4px;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pony Password Generator</h1>
        
        <form id="passwordForm">
            <div class="form-group">
                <label for="count">Number of passwords:</label>
                <input type="number" id="count" name="count" min="1" max="50" placeholder="e.g. 5" required>
            </div>
            
            <div class="form-group">
                <label for="minLength">Minimum length:</label>
                <input type="number" id="minLength" name="minLength" min="1" placeholder="e.g. 16" required>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="special" name="special">
                    <label for="special">Enable special character replacement (o→0, i→!, e→€, s→$)</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Select ponies to use (leave empty to use all):</label>
                <div class="ponies-grid" id="poniesGrid"></div>
            </div>
            
            <button type="submit" id="generateBtn">Generate Passwords</button>
        </form>
        
        <div id="result" style="display: none;"></div>
        <div id="error" style="display: none;"></div>
    </div>

    <script>
        var mcpUrl = 'http://localhost:3001/mcp';
        if (window.parent && window.parent.location && window.parent.location.origin) {
            mcpUrl = window.parent.location.origin + '/mcp';
        }
        
        var mcpSessionId = null;
        var mcpSessionInitialized = false;
        var mcpSessionPromise = null;
        
        function initMcpSession() {
            if (mcpSessionPromise) {
                return mcpSessionPromise;
            }
            
            mcpSessionPromise = fetch(mcpUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json, text/event-stream'
                },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'initialize',
                    params: {
                        protocolVersion: '2024-11-05',
                        capabilities: {},
                        clientInfo: { name: 'password-form', version: '1.0.0' }
                    }
                })
            })
            .then(function(response) {
                console.log('MCP initialize response status:', response.status);
                mcpSessionId = response.headers.get('mcp-session-id') || response.headers.get('Mcp-Session-Id');
                console.log('MCP Session ID:', mcpSessionId);
                if (!mcpSessionId) {
                    throw new Error('No session ID received from MCP server');
                }
                mcpSessionInitialized = true;
                
                // Handle SSE (Server-Sent Events) response format
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    return response.text().then(function(text) {
                        var lines = text.split('\n');
                        for (var i = 0; i < lines.length; i++) {
                            if (lines[i].startsWith('data: ')) {
                                var jsonData = lines[i].substring(6);
                                return JSON.parse(jsonData);
                            }
                        }
                        throw new Error('No data found in SSE response');
                    });
                } else {
                    return response.json();
                }
            })
            .catch(function(err) {
                console.error('MCP initialization error:', err);
                mcpSessionPromise = null;
                throw err;
            });
            
            return mcpSessionPromise;
        }
        
        function callMcpTool(name, args) {
            return initMcpSession()
            .then(function() {
                if (!mcpSessionId) {
                    throw new Error('MCP session not initialized');
                }
                
                console.log('Calling MCP tool with session ID:', mcpSessionId);
                
                return fetch(mcpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream',
                        'mcp-session-id': mcpSessionId
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now(),
                        method: 'tools/call',
                        params: { name: name, arguments: args }
                    })
                });
            })
            .then(function(response) {
                console.log('Tool call response status:', response.status);
                if (!response.ok) {
                    return response.text().then(function(text) {
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    return response.text().then(function(text) {
                        var lines = text.split('\n');
                        for (var i = 0; i < lines.length; i++) {
                            if (lines[i].startsWith('data: ')) {
                                var jsonData = lines[i].substring(6); 
                                return JSON.parse(jsonData);
                            }
                        }
                        throw new Error('No data found in SSE response');
                    });
                } else {
                    return response.json();
                }
            })
            .then(function(data) {
                console.log('Tool call result:', data);
                if (data.error) {
                    throw new Error(data.error.message || 'Tool call failed');
                }
                if (data.result && data.result.content && data.result.content[0]) {
                    var text = data.result.content[0].text;
                    try {
                        return { result: JSON.parse(text) };
                    } catch (e) {
                        return { result: text };
                    }
                }
                if (data.result && data.result.structuredContent) {
                    return { result: data.result.structuredContent.result };
                }
                return { result: data.result };
            });
        }
        
        initMcpSession().catch(function(err) {
            console.error('Failed to initialize MCP session:', err);
        });
        
        console.log('=== FORM INITIALIZATION ===');
        const windowData = window.__MCP_INITIAL_DATA__ || {};
        let initialData = windowData.initialData || {};
        let allPonies = windowData.ponies || [];
        
        console.log('Initial data keys:', Object.keys(initialData));
        console.log('Number of ponies:', allPonies.length);
        
        // Pre-fill form fields from tool args (e.g. count, minLength, special)
        var countEl = document.getElementById('count');
        var minLengthEl = document.getElementById('minLength');
        var specialEl = document.getElementById('special');
        if (countEl && initialData.count != null) countEl.value = Number(initialData.count);
        if (minLengthEl && initialData.minLength != null) minLengthEl.value = Number(initialData.minLength);
        if (specialEl && initialData.special != null) specialEl.checked = !!initialData.special;
        
        if (allPonies.length === 0) {
            console.warn('WARNING: No ponies found in window data!');
        } else {
            var firstThree = allPonies.slice(0, 3).map(function(p) { 
                return p.last ? p.first + ' ' + p.last : p.first; 
            });
            console.log('First 3 ponies:', firstThree);
        }
        
        if (allPonies.length > 0) {
            console.log('Rendering ponies immediately (from window data)');
            renderPonies(allPonies, []);
        } else {
            console.log('No ponies to render initially');
        }
        
        function renderPonies(ponies, selectedPonies) {
            if (!selectedPonies) selectedPonies = [];
            console.log('=== RENDER PONIES: ' + ponies.length + ' ponies, ' + selectedPonies.length + ' selected ===');
            
            const grid = document.getElementById('poniesGrid');
            if (!grid) {
                console.error('Ponies grid element not found!');
                return;
            }
            
            grid.innerHTML = '';
            
            if (!ponies || ponies.length === 0) {
                console.log('No ponies to render - grid will be empty');
                return;
            }
            
            function formatPonyName(name) {
                return name.replace(/([a-z])([A-Z])/g, '$1 $2');
            }
            
            ponies.forEach(function(pony) {
                var fullName = pony.last ? pony.first + pony.last.replace(/\s+/g, '') : pony.first;
                var displayName;
                if (pony.last) {
                    displayName = pony.first + ' ' + pony.last;
                } else {
                    displayName = formatPonyName(pony.first);
                }
                var isSelected = selectedPonies.indexOf(fullName) !== -1;
                
                var div = document.createElement('div');
                div.className = 'pony-checkbox';
                div.innerHTML = '<input type="checkbox" id="pony-' + fullName + '" value="' + fullName + '"' + (isSelected ? ' checked' : '') + '>' +
                    '<label for="pony-' + fullName + '">' + displayName + '</label>';
                grid.appendChild(div);
            });
            
            console.log('Rendered ' + ponies.length + ' ponies in grid');
        }
        
        const form = document.getElementById('passwordForm');
        if (!form) {
            console.error('Password form not found!');
        } else {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                console.log('\n=== FORM SUBMIT ===');
                
                const countInput = document.getElementById('count');
                const minLengthInput = document.getElementById('minLength');
                const specialInput = document.getElementById('special');
                
                if (!countInput || !minLengthInput || !specialInput) {
                    console.error('Form inputs not found!');
                    return;
                }
                
                const count = parseInt(countInput.value);
                const minLength = parseInt(minLengthInput.value);
                const special = specialInput.checked;
                
                console.log('Form values:', { count, minLength, special });
                
                var checkboxes = document.querySelectorAll('#poniesGrid input[type="checkbox"]:checked');
                var selectedPonies = [];
                for (var i = 0; i < checkboxes.length; i++) {
                    selectedPonies.push(checkboxes[i].value);
                }
                
                console.log('Selected ponies:', selectedPonies);
                
                const generateBtn = document.getElementById('generateBtn');
                const resultDiv = document.getElementById('result');
                const errorDiv = document.getElementById('error');
                
                if (!generateBtn || !resultDiv || !errorDiv) {
                    console.error('Required elements not found!');
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                resultDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                
                try {
                    console.log('Calling tool with args:', {
                        count: count,
                        minLength: minLength,
                        special: special,
                        selectedPonies: selectedPonies.length > 0 ? selectedPonies : undefined
                    });
                    
                    var toolArgs = {
                        count: count,
                        minLength: minLength,
                        special: special
                    };
                    if (selectedPonies.length > 0) {
                        toolArgs.selectedPonies = selectedPonies;
                    }
                    
                    var result = await callMcpTool('pony_password_batch', toolArgs);
                    
                    console.log('Tool result:', result);
                    
                    var passwords = null;
                    if (result && result.result && Array.isArray(result.result)) {
                        passwords = result.result;
                        console.log('Generated passwords:', passwords);
                    } else if (result.content && result.content[0] && result.content[0].text) {
                        passwords = JSON.parse(result.content[0].text);
                        console.log('Generated passwords (from content):', passwords);
                    } else {
                        console.error('Invalid response format:', result);
                        throw new Error('Invalid response from server');
                    }
                    
                    if (passwords) {
                        var passwordHtml = '<h3>Generated Passwords:</h3>';
                        for (var i = 0; i < passwords.length; i++) {
                            passwordHtml += '<div class="password">' + passwords[i] + '</div>';
                        }
                        resultDiv.innerHTML = passwordHtml;
                        resultDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error generating passwords:', error);
                    errorDiv.textContent = 'Error: ' + (error.message || String(error));
                    errorDiv.style.display = 'block';
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Passwords';
                }
            });
        }
    </script>
</body>
</html>

